import telebot
import requests
import json
import os
from flask import Flask, request
import base64
from dotenv import load_dotenv

load_dotenv()

BOT_TOKEN = os.getenv("BOT_TOKEN")
OPENWEATHER_API_KEY = os.getenv("OPENWEATHER_API_KEY")

bot = telebot.TeleBot(BOT_TOKEN)
app = Flask(__name__)

# Kitab m…ôlumatlarƒ±
books = {
    "Dini Kitablar": {
        "H…ôdisl…ôr": [
            {
                "ad": "Q√ºtb√º Sitte",
                "m√º…ôllif": "Buxari",
                "haqqinda": "S…ôhih h…ôdisl…ôr toplusudur.",
                "qiymet": "12 AZN"
            },
            {
                "ad": "N…ôhc√ºl B…ôlaƒü…ô",
                "m√º…ôllif": "ƒ∞mam ∆èli",
                "haqqinda": "ƒ∞mam ∆èlinin x√ºtb…ôl…ôri v…ô m…ôktublarƒ±.",
                "qiymet": "15 AZN"
            }
        ]
    }
}

@bot.message_handler(commands=['start'])
def send_welcome(message):
    markup = telebot.types.ReplyKeyboardMarkup(resize_keyboard=True)
    markup.add("Kitablar", "MP3", "Hava", "∆èlaq…ô")
    bot.send_message(message.chat.id, "Salam! N…ô il…ô maraqlanƒ±rsan?", reply_markup=markup)

def get_spotify_token():
    auth_str = f"{SPOTIFY_CLIENT_ID}:{SPOTIFY_CLIENT_SECRET}"
    b64_auth_str = base64.b64encode(auth_str.encode()).decode()
    response = requests.post(
        "https://accounts.spotify.com/api/token",
        headers={"Authorization": f"Basic {b64_auth_str}"},
        data={"grant_type": "client_credentials"}
    )
    return response.json().get("access_token") if response.status_code == 200 else None

def search_spotify(query):
    token = get_spotify_token()
    if not token:
        return "Spotify il…ô …ôlaq…ô qurulmadƒ±."

    headers = {"Authorization": f"Bearer {token}"}
    params = {"q": query, "type": "track", "limit": 3}
    response = requests.get("https://api.spotify.com/v1/search", headers=headers, params=params)

    if response.status_code != 200:
        return "Mahnƒ± tapƒ±lmadƒ±."

    tracks = response.json().get("tracks", {}).get("items", [])
    if not tracks:
        return "N…ôtic…ô tapƒ±lmadƒ±."

    result_message = ""
    for track in tracks:
        name = track["name"]
        artists = ", ".join([artist["name"] for artist in track["artists"]])
        url = track["external_urls"]["spotify"]
        result_message += f"üéß <b>{name}</b> - {artists}\nüîó <a href='{url}'>Spotify'da dinl…ô</a>\n\n"

    return result_message.strip()

def get_weather(city):
    url = f"http://api.openweathermap.org/data/2.5/weather?q={city}&appid={OPENWEATHER_API_KEY}&units=metric&lang=az"
    response = requests.get(url)
    data = response.json()

    if data.get("cod") != 200:
        return "Hava m…ôlumatƒ± tapƒ±lmadƒ±."

    desc = data["weather"][0]["description"]
    temp = data["main"]["temp"]
    name = data["name"]
    
    return f"{name} ≈ü…ôh…ôrind…ô hava: {desc}, temperatur: {temp}¬∞C"

def handle_dialogs(text, chat_id):
    if any(word in text for word in ["salam", "salamm", "salam …ôleykum", "salam aleykum"]):
        bot.send_message(chat_id, "∆èleykum Salam!")
    elif "nec…ôs…ôn?", in text or "yax≈üƒ±san?", in text or "nec…ôs…ôn":
        bot.send_message(chat_id, "≈û√ºk√ºr m…ôn yax≈üƒ±yam! S…ôn nec…ôs…ôn?")
    elif "√ßox saƒü ol", in text or "√ßox saƒüol", in text or "t…ô≈ü…ôkk√ºr", in text or "yax≈üƒ±yam", in text or "≈û√ºk√ºr Allaha salamatlƒ±qdƒ±":
        bot.send_message(chat_id, "D…ôym…ôz, h…ômi≈ü…ô yax≈üƒ± ol! üòä", "h…ômi≈ü…ô salamatlƒ±q olsun t…ôki")
    elif any(word in text for word in ["qiym…ôt", "ne√ß…ôy…ô", "ne√ß…ôy…ôdƒ±r", "ne√ß…ôyidir", "ne√ß…ôdir"]):
        bot.send_message(chat_id, "Qiym…ôtl…ôr kitabdan asƒ±lƒ± olaraq d…ôyi≈üir. Hansƒ± kitabla maraqlanƒ±rsƒ±nƒ±z?")
    elif any(word in text for word in ["…ôlaq…ô", "n√∂mr…ô"]):
        bot.send_message(chat_id, "Bizim …ôlaq…ô n√∂mr…ômiz: +994 XX XXX XX XX")
    elif any(word in text for word in ["√ßatdƒ±r", "√ßatdƒ±rƒ±lma"]):
        bot.send_message(chat_id, "√áatdƒ±rƒ±lma Bakƒ±da 1 g√ºn…ô, b√∂lg…ôl…ôr…ô 2-3 g√ºn…ô √ßatƒ±r.")
    elif "s…ôni kim yaradƒ±b" in text:
        bot.send_message(chat_id, "M…ôni Kamran qarda≈üƒ±m yaradƒ±b! ü§ñ‚ù§Ô∏è")
bot.reply_to(...)
@bot.message_handler(func=lambda message: True)
def handle_message(message):
    text = message.text.lower()
    chat_id = message.chat.id

    if text == "kitablar":
        markup = telebot.types.ReplyKeyboardMarkup(resize_keyboard=True)
        markup.add("H…ôdisl…ôr", "üîô Geri")
        bot.send_message(chat_id, "Z…ôhm…ôt olmasa b√∂lm…ô se√ßin:", reply_markup=markup)

    elif text == "h…ôdisl…ôr":
        for kitab in books["Dini Kitablar"]["H…ôdisl…ôr"]:
            msg = f"üìò <b>{kitab['ad']}</b>\n‚úçÔ∏è M√º…ôllif: {kitab['m√º…ôllif']}\n‚ÑπÔ∏è {kitab['haqqinda']}\nüí∞ Qiym…ôt: {kitab['qiymet']}"
            bot.send_message(chat_id, msg, parse_mode="HTML")

   elif text == "mp3"
    bot.send_message(chat_id, "Z…ôhm…ôt olmasa dinl…ôm…ôk ist…ôdiyiniz m…ôrsiy…ô v…ô ya ifa√ßƒ± adƒ±nƒ± yazƒ±n.")

elif any(keyword in text for keyword in [
    "abas…ôlt", "…ôba-…ôbdillah", "aldƒ± h√ºseyn", "anam z…ôhra", "l…ôbeyk", "ya …ôli", "ya huseyn",
    "ruq…ôyy…ô", "z…ôhra", "sahibi zaman", "…ôli m√∂vla", "…ôli …ôkb…ôr", "…ôlinin yari", "zeyn…ôb", "lay-lay"
]):

    drive_links = {
        if 'abas…ôlt ebrahimi - abufazil' in text:
        context.bot.send_audio(chat_id=update.effective_chat.id, audio='https://drive.google.com/uc?export=download&id=1bCAe_7IjAbcZVGNNFvG01MXYZ')
    elif 'abas…ôlt ebrahimi - aldƒ± h√ºseyn qan il…ô bir d…ôst…ômaz' in text:
        context.bot.send_audio(chat_id=update.effective_chat.id, audio='https://drive.google.com/uc?export=download&id=1cDEf_8KjBcYZWGNNFvG02NABC')
    elif 'abas…ôlt ebrahimi - h√ºseyn …ôba-…ôbdillah' in text:
        context.bot.send_audio(chat_id=update.effective_chat.id, audio='https://drive.google.com/uc?export=download&id=1dEFg_9LkCdZXWHNNFvG03NDEF')
    elif 'abas…ôlt ebrahimi - l…ôbbeyk ya …ôba-…ôbdillah' in text:
        context.bot.send_audio(chat_id=update.effective_chat.id, audio='https://drive.google.com/uc?export=download&id=1eFGh_0MlDeAYXINNFvG04NGHI')
    elif 'adel najafi - hz. …ôb…ôlf…ôzl' in text:
        context.bot.send_audio(chat_id=update.effective_chat.id, audio='https://drive.google.com/uc?export=download&id=1fGHi_1NmEfBZYOONFvG05NJJK')
    elif 'hacƒ± islam mirzai - anam z…ôhra' in text:
        context.bot.send_audio(chat_id=update.effective_chat.id, audio='https://drive.google.com/uc?export=download&id=1gHIj_2OnFgCZZPPNFvG06NKLM')
    elif 'baqir m…ônsuri - ruq…ôyy…ô nazlƒ± sur…ôtin' in text:
        context.bot.send_audio(chat_id=update.effective_chat.id, audio='https://drive.google.com/uc?export=download&id=1hIJk_3PoGhDAAQQNFvG07NLMN')
    elif 'ceyhun m√º…ôzzin - …ôli m√∂vla' in text:
        context.bot.send_audio(chat_id=update.effective_chat.id, audio='https://drive.google.com/uc?export=download&id=1iJKl_4QpHiEBBRRNFvG08NMOP')
    elif '…ôhlibeyt qrupu - …ôli …ôkb…ôr' in text:
        context.bot.send_audio(chat_id=update.effective_chat.id, audio='https://drive.google.com/uc?export=download&id=1jKLm_5RqIjFCCSSNFvG09NPQR')
    elif '…ôhlibeyt qrupu - sahibi zaman g…ôldi' in text:
        context.bot.send_audio(chat_id=update.effective_chat.id, audio='https://drive.google.com/uc?export=download&id=1kLMn_6SrJkGDDTTNFvG10NQRS')
    elif '…ôhlibeyt qrupu - ya …ôli' in text:
        context.bot.send_audio(chat_id=update.effective_chat.id, audio='https://drive.google.com/uc?export=download&id=1lMNo_7TsKlHEEUUNFvG11NRTS')
    elif '…ôkb…ôr babazad…ô - …ôli lay-lay g√ºl√ºm lay-lay' in text:
        context.bot.send_audio(chat_id=update.effective_chat.id, audio='https://drive.google.com/uc?export=download&id=1mNOp_8UtLmIFFVVNFvG12NSUV')
    elif 'mehdi r…ôsuli - …ôlini aƒülatma' in text:
        context.bot.send_audio(chat_id=update.effective_chat.id, audio='https://drive.google.com/uc?export=download&id=1nOPq_9VuMnJGGWWNFvG13NTVW')
    elif 'baqir m…ônsuri - …ôlinin yari z…ôhra' in text:
        context.bot.send_audio(chat_id=update.effective_chat.id, audio='https://drive.google.com/uc?export=download&id=1oPQr_0WvNoKHHXXNFvG14NUWX')
    elif 'baqir m…ônsuri - aƒülaram z…ôhra' in text:
        context.bot.send_audio(chat_id=update.effective_chat.id, audio='https://drive.google.com/uc?export=download&id=1pQRs_1XwOpLIYYYNFvG15NVXY')
    elif 'baqir m…ônsuri - aƒülama xudahafiz' in text:
        context.bot.send_audio(chat_id=update.effective_chat.id, audio='https://drive.google.com/uc?export=download&id=1qRSt_2YxPqMJZZZNFvG16NWYZ')
    elif 'hacƒ± kamran - yaralƒ± z…ôhra' in text:
        context.bot.send_audio(chat_id=update.effective_chat.id, audio='https://drive.google.com/uc?export=download&id=1rSTu_3ZyQrNKAAANFvG17NXZA')
    elif 'hacƒ± kamran - ya h√ºseyn' in text:
        context.bot.send_audio(chat_id=update.effective_chat.id, audio='https://drive.google.com/uc?export=download&id=1sTUV_4AzRsOLBBBNFvG18NYAB')
    elif 'hacƒ± zahir - g√∂z√ºn a√ß z…ôhra' in text:
        context.bot.send_audio(chat_id=update.effective_chat.id, audio='https://drive.google.com/uc?export=download&id=1tUVW_5BaStPMCCCCNFvG19NZBC')
    elif 'hadi kazemi - bab…ôl h√ºseyn' in text:
        context.bot.send_audio(chat_id=update.effective_chat.id, audio='https://drive.google.com/uc?export=download&id=1uVWX_6CbTuQNDDDNFvG20NACD')
    elif 'hadi kazemi - h…ôbibi ya h√ºseyn' in text:
        context.bot.send_audio(chat_id=update.effective_chat.id, audio='https://drive.google.com/uc?export=download&id=1vWXY_7DcUvREDDDEFvG21NBDC')
    elif 'hadi kazemi - m…ôzlum …ôli' in text:
        context.bot.send_audio(chat_id=update.effective_chat.id, audio='https://drive.google.com/uc?export=download&id=1wXYZ_8EdVwSFEFFNFvG22NCEC')
    elif 'hadi kazemi - million army' in text:
        context.bot.send_audio(chat_id=update.effective_chat.id, audio='https://drive.google.com/uc?export=download&id=1xYZA_9FeWxTGFGGNFvG23NDFC')
    elif 'h…ôs…ôn nem…ôti - salam qar…ô p…ôr√ß…ôm…ô' in text:
        context.bot.send_audio(chat_id=update.effective_chat.id, audio='https://drive.google.com/uc?export=download&id=1yZAB_0GfXyUHGHHNFvG24NEGC')
    elif '…ôkb…ôr babazad…ô - qara k√∂yn…ôk gey…ôr…ôm' in text:
        context.bot.send_audio(chat_id=update.effective_chat.id, audio='https://drive.google.com/uc?export=download&id=1zABC_1HgYzVIIIIIFvG25NFHC')
    elif 's…ôlim m√º…ôzzinzad…ô - zeyn…ôb zeyn…ôb' in text:
        context.bot.send_audio(chat_id=update.effective_chat.id, audio='https://drive.google.com/uc?export=download&id=1aBCD_2IhAzWJJJJJFvG26NGIC')
    else:
        update.message.reply_text('Baƒüƒ±≈ülayƒ±n, bu mahnƒ±nƒ± tapa bilm…ôdim.')
# burda s…ôn ist…ôdikc…ô …ôlav…ô ed…ô bil…ôrs…ôn
    }

    found = False
    for keyword, link in drive_links.items():
        if keyword in text:
            bot.send_message(chat_id, f"Dinl…ô: {link}")
            found = True
            break

    if not found:
        bot.send_message(chat_id, "Mahnƒ± tapƒ±lmadƒ±. Z…ôhm…ôt olmasa daha d…ôqiq yazƒ±n.")

    elif text == "hava":
        bot.send_message(chat_id, "Z…ôhm…ôt olmasa ≈ü…ôh…ôr adƒ±nƒ± yazƒ±n.")

    elif text == "…ôlaq…ô":
        bot.send_message(chat_id, "Bizim …ôlaq…ô n√∂mr…ômiz: +994 XX XXX XX XX")

    elif text == "üîô geri":
        send_welcome(message)

    elif text in ["sami yusuf", "p…ôrviz h√ºseyni", "baqir m…ônsuri", "m…ôrsiy…ôl…ôr"]:
        result = search_spotify(text)
        bot.send_message(chat_id, result, parse_mode="HTML", disable_web_page_preview=True)

    elif text.isalpha() and len(text) > 2:
        weather_result = get_weather(text)
        bot.send_message(chat_id, weather_result)

    else:
        handle_dialogs(text, chat_id)

@app.route(f"/{BOT_TOKEN}", methods=["POST"])
def webhook():
    update = telebot.types.Update.de_json(request.stream.read().decode("utf-8"))
    bot.process_new_updates([update])
    return "", 200

@app.route("/")
def index():
    return "Bot i≈ü…ô d√º≈üd√º!"

if __name__ == "__main__":
    bot.remove_webhook()
    bot.set_webhook(url=f"https://tahastorebot.onrender.com/{BOT_TOKEN}")
    app.run(host="0.0.0.0", port=int(os.environ.get("PORT", 5000)))

